name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .
    
    - name: Build EXE
      run: |
        pyinstaller scripts/build.spec --clean --noconfirm
    
    - name: Create distribution package
      run: |
        $version = "${{ github.ref_name }}"
        $zipName = "transcoder-cluster-windows-$version"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        New-Item -ItemType Directory -Path "dist\$zipName"
        
        # å¤åˆ¶ EXE æ–‡ä»¶å¤¹
        Copy-Item -Path "dist\tc-worker-gui" -Destination "dist\$zipName\tc-worker-gui" -Recurse
        Copy-Item -Path "dist\tc-control-gui" -Destination "dist\$zipName\tc-control-gui" -Recurse
        
        # å¤åˆ¶æ–‡æ¡£
        Copy-Item -Path "README.md" -Destination "dist\$zipName\"
        Copy-Item -Path "LICENSE" -Destination "dist\$zipName\"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        Compress-Archive -Path "dist\$zipName" -DestinationPath "dist\$zipName.zip"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/*.zip

  build-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .
    
    - name: Build APP
      run: |
        pyinstaller scripts/build.spec --clean --noconfirm
    
    - name: Create distribution package
      run: |
        version="${{ github.ref_name }}"
        zipName="transcoder-cluster-macos-$version"
        
        # åˆ›å»ºç›®å½•
        mkdir -p "dist/$zipName"
        
        # å¤åˆ¶ APP æ–‡ä»¶å¤¹
        cp -r "dist/tc-worker-gui" "dist/$zipName/"
        cp -r "dist/tc-control-gui" "dist/$zipName/"
        
        # å¤åˆ¶æ–‡æ¡£
        cp README.md "dist/$zipName/"
        cp LICENSE "dist/$zipName/"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd dist
        zip -r "$zipName.zip" "$zipName"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: dist/*.zip

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .
    
    - name: Build executable
      run: |
        pyinstaller scripts/build.spec --clean --noconfirm
    
    - name: Create distribution package
      run: |
        version="${{ github.ref_name }}"
        zipName="transcoder-cluster-linux-$version"
        
        # åˆ›å»ºç›®å½•
        mkdir -p "dist/$zipName"
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¤¹
        cp -r "dist/tc-worker-gui" "dist/$zipName/"
        cp -r "dist/tc-control-gui" "dist/$zipName/"
        
        # å¤åˆ¶æ–‡æ¡£
        cp README.md "dist/$zipName/"
        cp LICENSE "dist/$zipName/"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd dist
        zip -r "$zipName.zip" "$zipName"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: dist/*.zip

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: artifacts/windows
    
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: macos-build
        path: artifacts/macos
    
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: linux-build
        path: artifacts/linux
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/windows/*.zip
          artifacts/macos/*.zip
          artifacts/linux/*.zip
        body: |
          # Transcoder Cluster ${{ github.ref_name }}
          
          ## ğŸ“¥ ä¸‹è½½
          
          | å¹³å° | æ–‡ä»¶ |
          |------|------|
          | Windows | `transcoder-cluster-windows-${{ github.ref_name }}.zip` |
          | macOS | `transcoder-cluster-macos-${{ github.ref_name }}.zip` |
          | Linux | `transcoder-cluster-linux-${{ github.ref_name }}.zip` |
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `tc-worker-gui` æˆ– `tc-control-gui`
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          
          - **éœ€è¦å®‰è£… FFmpeg** æ‰èƒ½è¿›è¡Œè§†é¢‘è½¬ç 
          - Windows ç”¨æˆ·å¯èƒ½éœ€è¦å…è®¸é˜²ç«å¢™é€šè¿‡
          
          ## ğŸ“ æ›´æ–°æ—¥å¿—
          
          å‚è§ [README.md](https://github.com/ybyllc/transcoder-cluster#-æ›´æ–°æ—¥å¿—)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
