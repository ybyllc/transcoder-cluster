name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'è¦å‘å¸ƒçš„æ ‡ç­¾ï¼ˆå¦‚ v0.2.0ï¼‰ï¼Œç•™ç©ºåˆ™åªæ‰§è¡Œæž„å»º'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        pip install -e .
    
    - name: Build Worker EXE
      run: |
        pyinstaller --onefile --windowed --name tc-worker-gui `
          --hidden-import=transcoder_cluster `
          --hidden-import=transcoder_cluster.core `
          --hidden-import=transcoder_cluster.core.worker `
          --hidden-import=transcoder_cluster.core.controller `
          --hidden-import=transcoder_cluster.core.discovery `
          --hidden-import=transcoder_cluster.transcode `
          --hidden-import=transcoder_cluster.transcode.ffmpeg_wrapper `
          --hidden-import=transcoder_cluster.transcode.presets `
          --hidden-import=transcoder_cluster.utils `
          --hidden-import=transcoder_cluster.utils.config `
          --hidden-import=transcoder_cluster.utils.logger `
          --hidden-import=requests `
          --hidden-import=ffmpeg `
          --collect-all requests `
          --collect-all certifi `
          gui/worker_app.py --clean --noconfirm
    
    - name: Build Controller EXE
      run: |
        pyinstaller --onefile --windowed --name tc-control-gui `
          --hidden-import=transcoder_cluster `
          --hidden-import=transcoder_cluster.core `
          --hidden-import=transcoder_cluster.core.worker `
          --hidden-import=transcoder_cluster.core.controller `
          --hidden-import=transcoder_cluster.core.discovery `
          --hidden-import=transcoder_cluster.transcode `
          --hidden-import=transcoder_cluster.transcode.ffmpeg_wrapper `
          --hidden-import=transcoder_cluster.transcode.presets `
          --hidden-import=transcoder_cluster.utils `
          --hidden-import=transcoder_cluster.utils.config `
          --hidden-import=transcoder_cluster.utils.logger `
          --hidden-import=requests `
          --hidden-import=ffmpeg `
          --collect-all requests `
          --collect-all certifi `
          gui/controller_app.py --clean --noconfirm
    
    - name: Upload Worker EXE
      uses: actions/upload-artifact@v4
      with:
        name: tc-worker-gui
        path: dist/tc-worker-gui.exe
    
    - name: Upload Controller EXE
      uses: actions/upload-artifact@v4
      with:
        name: tc-control-gui
        path: dist/tc-control-gui.exe

  release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.tag != '')
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}

    - name: Download Worker EXE
      uses: actions/download-artifact@v4
      with:
        name: tc-worker-gui
        path: artifacts/
    
    - name: Download Controller EXE
      uses: actions/download-artifact@v4
      with:
        name: tc-control-gui
        path: artifacts/

    - name: Prepare Release Notes
      shell: bash
      run: |
        set -euo pipefail
        TAG="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}"
        NOTES_FILE=".github/release-notes/${TAG}.md"

        if [[ -f "$NOTES_FILE" ]]; then
          cp "$NOTES_FILE" release_body.md
          exit 0
        fi

        PREV_TAG="$(git tag --sort=-v:refname | grep -Fxv "$TAG" | head -n 1 || true)"
        {
          echo "## ðŸ“¥ ä¸‹è½½"
          echo
          echo "| æ–‡ä»¶ | è¯´æ˜Ž |"
          echo "|------|------|"
          echo "| \`tc-worker-gui.exe\` | Worker èŠ‚ç‚¹ç¨‹åº |"
          echo "| \`tc-control-gui.exe\` | ä¸»æŽ§ç«¯ç¨‹åº |"
          echo
          echo "## ðŸš€ ä½¿ç”¨æ–¹æ³•"
          echo
          echo "1. ä¸‹è½½ EXE æ–‡ä»¶"
          echo "2. åŒå‡»è¿è¡Œå³å¯ï¼ˆæ— éœ€å®‰è£…ï¼‰"
          echo
          echo "## âš ï¸ æ³¨æ„äº‹é¡¹"
          echo
          echo "- **éœ€è¦å®‰è£… FFmpeg** å¹¶æ·»åŠ åˆ°ç³»ç»Ÿ PATH æ‰èƒ½è¿›è¡Œè§†é¢‘è½¬ç "
          echo "- é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å…è®¸é˜²ç«å¢™é€šè¿‡"
          echo
          echo "## ðŸ“ æ›´æ–°æ—¥å¿—ï¼ˆè¯¦ç»†ï¼‰"
          echo
          if [[ -n "$PREV_TAG" ]]; then
            echo "å¯¹æ¯”èŒƒå›´: \`${PREV_TAG}...${TAG}\`"
            echo
            git log --no-merges --pretty=format:'- `%h` %s' "${PREV_TAG}..${TAG}"
          else
            echo "æäº¤åˆ—è¡¨:"
            echo
            git log --no-merges --pretty=format:'- `%h` %s' "${TAG}"
          fi
          echo
        } > release_body.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
        name: Transcoder Cluster ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
        files: |
          artifacts/tc-worker-gui.exe
          artifacts/tc-control-gui.exe
        body_path: release_body.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
