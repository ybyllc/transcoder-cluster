name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .
    
    - name: Build Worker EXE
      run: |
        pyinstaller --onefile --windowed--name tc-worker-gui `
          --hidden-import=transcoder_cluster `
          --hidden-import=transcoder_cluster.core `
          --hidden-import=transcoder_cluster.core.worker `
          --hidden-import=transcoder_cluster.core.controller `
          --hidden-import=transcoder_cluster.core.discovery `
          --hidden-import=transcoder_cluster.transcode `
          --hidden-import=transcoder_cluster.transcode.ffmpeg_wrapper `
          --hidden-import=transcoder_cluster.transcode.presets `
          --hidden-import=transcoder_cluster.utils `
          --hidden-import=transcoder_cluster.utils.config `
          --hidden-import=transcoder_cluster.utils.logger `
          --hidden-import=requests `
          --hidden-import=ffmpeg `
          --collect-all requests `
          --collect-all certifi `
          gui/worker_app.py --clean --noconfirm
    
    - name: Build Controller EXE
      run: |
        pyinstaller --onefile --windowed --name tc-control-gui `
          --hidden-import=transcoder_cluster `
          --hidden-import=transcoder_cluster.core `
          --hidden-import=transcoder_cluster.core.worker `
          --hidden-import=transcoder_cluster.core.controller `
          --hidden-import=transcoder_cluster.core.discovery `
          --hidden-import=transcoder_cluster.transcode `
          --hidden-import=transcoder_cluster.transcode.ffmpeg_wrapper `
          --hidden-import=transcoder_cluster.transcode.presets `
          --hidden-import=transcoder_cluster.utils `
          --hidden-import=transcoder_cluster.utils.config `
          --hidden-import=transcoder_cluster.utils.logger `
          --hidden-import=requests `
          --hidden-import=ffmpeg `
          --collect-all requests `
          --collect-all certifi `
          gui/controller_app.py --clean --noconfirm
    
    - name: Upload Worker EXE
      uses: actions/upload-artifact@v4
      with:
        name: tc-worker-gui
        path: dist/tc-worker-gui.exe
    
    - name: Upload Controller EXE
      uses: actions/upload-artifact@v4
      with:
        name: tc-control-gui
        path: dist/tc-control-gui.exe

  release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Worker EXE
      uses: actions/download-artifact@v4
      with:
        name: tc-worker-gui
        path: artifacts/
    
    - name: Download Controller EXE
      uses: actions/download-artifact@v4
      with:
        name: tc-control-gui
        path: artifacts/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/tc-worker-gui.exe
          artifacts/tc-control-gui.exe
        body: |
          # Transcoder Cluster ${{ github.ref_name }}
          
          ##ğŸ“¥ ä¸‹è½½
          
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | `tc-worker-gui.exe` | Worker èŠ‚ç‚¹ç¨‹åº |
          | `tc-control-gui.exe` | æ§åˆ¶ç«¯ç¨‹åº |
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½ EXE æ–‡ä»¶
          2. åŒå‡»è¿è¡Œå³å¯ï¼ˆæ— éœ€å®‰è£…ï¼‰
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          
          - **éœ€è¦å®‰è£… FFmpeg** å¹¶æ·»åŠ åˆ°ç³»ç»Ÿ PATH æ‰èƒ½è¿›è¡Œè§†é¢‘è½¬ç 
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å…è®¸é˜²ç«å¢™é€šè¿‡
          
          ## ğŸ“ æ›´æ–°æ—¥å¿—
          
          å‚è§ [README.md](https://github.com/ybyllc/transcoder-cluster#-æ›´æ–°æ—¥å¿—)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
